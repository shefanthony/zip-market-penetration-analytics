<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZIP Code Market Penetration Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1d1d1f;
        }

        .header p {
            font-size: 1.1rem;
            color: #86868b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #007aff;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filters {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filters h3 {
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #1d1d1f;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: #86868b;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #007aff;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056cc;
        }

        .btn-secondary {
            background: #f2f2f7;
            color: #1d1d1f;
        }

        .btn-secondary:hover {
            background: #e5e5ea;
        }

        .data-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 30px;
            border-bottom: 1px solid #d2d2d7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            font-size: 1.3rem;
            color: #1d1d1f;
        }

        .table-info {
            font-size: 0.9rem;
            color: #86868b;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f2f2f7;
        }

        th {
            background: #f9f9fb;
            font-weight: 600;
            color: #1d1d1f;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th:hover {
            background: #f2f2f7;
        }

        th.sortable::after {
            content: 'â†•';
            position: absolute;
            right: 8px;
            opacity: 0.5;
        }

        th.sorted-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: #007aff;
        }

        th.sorted-desc::after {
            content: 'â†“';
            opacity: 1;
            color: #007aff;
        }

        .penetration-high {
            color: #28a745;
            font-weight: 600;
        }

        .penetration-medium {
            color: #ffc107;
            font-weight: 600;
        }

        .penetration-low {
            color: #dc3545;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        /* Login Overlay Styles */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #d91a72 0%, #f01d59 50%, #e91e63 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .login-overlay.fade-out {
            opacity: 0;
            transform: scale(1.1);
        }

        .login-form {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 50px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 100px rgba(249, 29, 89, 0.2);
            text-align: center;
            max-width: 450px;
            width: 90%;
            transform: scale(1);
            transition: all 0.3s ease;
            border: 1px solid rgba(249, 29, 89, 0.2);
        }

        .login-form.loading {
            transform: scale(0.98);
        }

        .login-form h2 {
            color: #d91a72;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: bold;
        }

        .login-form p {
            color: #666;
            margin-bottom: 35px;
            font-size: 16px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
        }

        .login-input:focus {
            outline: none;
            border-color: #f01d59;
            box-shadow: 0 0 0 3px rgba(249, 29, 89, 0.1);
            background: white;
        }

        .login-btn {
            background: linear-gradient(135deg, #f01d59 0%, #d91a72 100%);
            color: white;
            padding: 15px 35px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(249, 29, 89, 0.3);
        }

        .login-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #d91a72 0%, #f01d59 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(249, 29, 89, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            color: #e74c3c;
            margin-top: 20px;
            display: none;
            background: rgba(231, 76, 60, 0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }

        .loading-container {
            display: none;
            text-align: center;
        }

        .loading-message {
            color: #d91a72;
            font-size: 18px;
            font-weight: 500;
            margin-top: 20px;
            opacity: 0;
            animation: fadeInOut 1s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            50% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shef-logo-large {
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 8px rgba(249, 29, 89, 0.2));
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }

            .login-form {
                padding: 30px 20px;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-form" id="loginFormContainer">
            <div class="shef-logo-large">
                <svg width="80" height="46" viewBox="0 0 43 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g id="Group 2147227384">
                        <path id="Vector" d="M10.7206 8.97307C9.47909 8.96289 5.53021 9.14841 4.48363 9.14841C4.31558 9.14841 4.28389 8.98144 4.35027 8.90544C5.45127 7.65112 6.86504 6.60984 8.1927 5.60387C9.70934 4.45487 11.2044 3.23706 13.0237 2.60092C13.7545 2.34539 14.5086 2.15209 15.2795 2.05634C16.1114 1.95281 17.3105 1.94264 17.6071 1.23349C17.9492 -0.0160422 15.1402 -0.142312 13.7521 0.102448C11.7995 0.44595 10.1214 1.3436 8.94803 1.9947C6.71673 3.38666 2.25532 6.33097 1.497 8.72531C1.38696 9.10053 1.35766 9.47575 1.46112 9.81686C1.73622 10.7241 2.61475 11.3321 3.58059 11.3177C5.74072 11.3716 7.89547 11.3991 10.0592 11.5667C10.1334 11.5721 10.165 11.6648 10.1094 11.7145C9.28652 12.4548 5.22102 16.1106 3.09019 18.0525C2.20269 18.9143 1.33852 19.7988 0.464181 20.6737C0.0712662 21.0663 -0.0734604 21.5205 0.0347855 22.0788C0.259052 23.937 2.36118 24.6605 3.03936 22.7293C3.06866 22.6437 3.10933 22.5629 3.15777 22.4857C4.00759 21.1381 5.31073 20.11 6.47213 19.0334C7.96903 17.6833 9.40135 16.2542 10.7822 14.7827C11.7911 13.7097 12.8251 12.6511 13.4657 11.307C14.157 9.79951 12.0656 8.98384 10.7212 8.97307H10.7206Z" fill="#F01D59"></path>
                        <path id="Vector_2" d="M42.8267 9.55532V9.55413C42.6808 8.93714 41.621 8.59723 38.2869 9.00536C37.6877 9.09094 37.089 9.1813 36.4617 9.27466C36.3995 9.28423 36.3481 9.22618 36.3642 9.16514C36.378 9.11308 36.3905 9.0676 36.4067 9.02331C36.558 8.59962 36.7057 8.17533 36.8642 7.75523C37.2667 6.68941 38.4119 3.62961 39.0536 2.66912C39.2271 2.41 39.5147 2.26398 39.9734 2.26398C40.2371 2.26398 40.4291 2.35015 40.4345 2.46745C40.4548 3.01023 40.9572 3.22567 41.4308 3.01681C41.6246 2.97313 41.8016 2.82711 41.9212 2.60329C41.9852 2.48361 42.0983 2.0635 42.0743 1.84986C42.0402 1.54586 41.9464 1.16645 41.7753 0.923484C41.1067 -0.0232419 39.7473 -0.0429904 39.111 0.212542C37.3785 0.907326 36.6118 2.85164 36.2009 3.83009C35.7237 4.96592 34.4624 8.07958 34.0283 9.23277C33.8811 9.62235 33.6455 9.7935 33.264 9.86831C32.6498 9.98979 32.0326 10.1035 31.4776 10.426C30.8449 10.7953 30.8048 11.3081 31.4142 11.7067C31.709 11.8988 32.0386 12.0364 32.3585 12.1956C32.395 12.2142 32.4129 12.2573 32.3986 12.2962C32.3184 12.5194 32.1014 13.1011 31.9835 13.4458C31.8759 13.7605 31.5894 14.0532 31.422 14.2064C30.3945 15.1471 27.5239 15.9352 26.7812 14.6737C26.5455 14.2734 26.6305 13.894 26.6843 13.6211C26.7542 13.2698 26.9516 13.0933 27.3074 12.9981C28.2494 12.7486 28.8061 12.6546 29.6912 12.0047C30.2301 11.6098 31.0697 10.7899 30.7546 9.60739C30.5494 8.8366 29.5782 8.1855 28.3785 8.34289C27.9766 8.39556 27.2883 8.66844 26.7142 9.21721C26.0294 9.8713 25.6784 10.2453 24.886 11.2202C24.4619 11.742 24.0038 12.1454 23.7299 12.274C22.5093 12.8455 22.2922 12.9167 21.0603 13.4625V13.4673C21.0555 13.4691 21.0507 13.4709 21.0459 13.4733C20.9568 13.5074 20.8169 13.5146 20.7409 13.4613C20.6853 13.423 20.7116 13.2794 20.7313 13.1896C20.9006 12.4434 21.141 11.7067 21.2355 10.9515C21.3354 10.1502 20.9628 9.70493 20.058 9.71152C19.1842 9.7175 18.4133 10.0784 17.7656 10.6696C17.4738 10.9365 17.2083 11.2327 16.9194 11.5044C16.9116 11.511 16.9039 11.517 16.8955 11.523C16.792 11.5888 16.6539 11.5086 16.6473 11.3859C16.6467 11.3644 16.6455 11.3423 16.6473 11.3213C16.6497 11.2621 16.6838 11.2034 16.7071 11.146C17.5187 9.07358 18.3774 7.02274 19.3289 5.0096C19.6549 4.31841 19.9001 3.58413 19.8654 2.79719C19.8474 2.38965 19.4198 2.08804 19.0227 2.18199C18.5622 2.29151 18.2226 2.57277 18.0031 2.97313C17.6795 3.56378 17.3793 4.16761 17.0887 4.77562C15.6223 7.83901 14.1738 10.912 12.6942 13.9688C12.1602 15.0711 11.6692 16.2829 11.6692 17.2075C11.6692 17.8 11.8211 18.3182 12.519 18.4271C12.9945 18.5013 13.5363 18.493 13.9041 18.0292C14.788 16.9173 15.6874 15.8168 16.5558 14.6929C17.3243 13.6983 18.0581 12.6762 18.808 11.6666C18.9157 11.5224 19.0156 11.4183 19.2075 11.4458C19.256 11.453 19.3236 11.4996 19.3236 11.575C19.3236 11.6654 19.2931 11.7426 19.2548 11.8246C19.0233 12.3237 18.7763 12.8156 18.5443 13.3147C18.3087 13.8204 18.0569 14.3177 17.9821 14.8856C17.8924 15.5744 18.283 16.0412 18.9617 16.0172C19.8038 15.9873 20.5489 15.6474 21.3025 15.3117C22.0034 14.9993 24.0732 14.0286 24.1719 13.9909C24.2347 13.967 24.2993 14.0215 24.2867 14.0873C24.1551 14.7605 24.1803 15.3416 24.563 15.8916C24.7502 16.1615 24.9535 16.4391 25.2077 16.6396C26.0354 17.2907 27.0108 17.323 28.0065 17.2392C28.6231 17.1878 29.1853 16.9903 29.7062 16.6647C29.8713 16.5624 30.0357 16.4607 30.2008 16.3577C30.3108 16.2889 30.4872 16.1824 30.6547 16.0807C30.7025 16.0513 30.7605 16.098 30.7426 16.1513C30.6888 16.3087 30.6122 16.5325 30.6027 16.5564C30.4436 16.9382 29.5501 19.7838 29.3252 20.3804C28.9078 21.4881 28.7158 22.4115 28.8426 23.0489C28.9604 23.6371 29.4197 23.8807 29.9855 23.9405C30.5177 23.9968 30.9722 23.8017 31.1863 23.1506C31.4274 22.4163 31.6337 21.6725 31.8609 20.9328C32.6312 18.4235 33.4392 16.7701 34.4565 14.3554C34.7997 13.5421 35.1926 12.7498 35.5365 11.9359C35.6268 11.7229 35.7381 11.6367 35.9557 11.6163C36.5347 11.5619 37.113 11.4919 37.6901 11.426C38.7534 11.3046 39.8167 11.1765 40.8806 11.0604C41.4649 10.997 43.0952 10.6876 42.8279 9.55473L42.8267 9.55532ZM27.0234 10.754C27.3104 10.3656 27.6782 10.0538 28.3151 9.79111C28.4862 9.71989 28.7709 9.6421 29.0477 9.6421C29.3282 9.6421 29.5088 9.88387 29.4149 10.1574C29.3199 10.4841 28.9234 10.7618 28.433 11.0245C28.0867 11.2106 27.5789 11.4021 27.3439 11.4637C27.1496 11.5146 26.8123 11.5649 26.7746 11.4739C26.7172 11.3345 26.713 11.1747 27.0234 10.7546V10.754Z" fill="#F01D59"></path>
                    </g>
                </svg>
            </div>
            <h2>ðŸ“Š Shef Market Analytics</h2>
            <p>Enter the team password to access the ZIP penetration dashboard</p>
            <form id="loginForm">
                <input type="password" class="login-input" id="passwordInput" placeholder="Enter password" required>
                <button type="submit" class="login-btn" id="loginBtn">Access Analytics</button>
                <div class="login-error" id="loginError">Incorrect password. Please try again.</div>
            </form>
            
            <div class="loading-container" id="loadingContainer">
                <div class="loading-message" id="loadingMessage"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ZIP Code Market Penetration Analysis</h1>
            <p>Analyze market penetration across ZIP codes using US Census population data</p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated here -->
        </div>

        <div class="filters">
            <h3>Filters & Search</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="zipCodeFilter">ZIP Code</label>
                    <input type="text" id="zipCodeFilter" placeholder="Search ZIP codes...">
                </div>
                <div class="filter-group">
                    <label for="areaNameFilter">Area Name</label>
                    <input type="text" id="areaNameFilter" placeholder="Search area names...">
                </div>
                <div class="filter-group">
                    <label for="minPenetrationFilter">Min Penetration (%)</label>
                    <input type="number" id="minPenetrationFilter" step="0.001" placeholder="0.000">
                </div>
                <div class="filter-group">
                    <label for="maxPenetrationFilter">Max Penetration (%)</label>
                    <input type="number" id="maxPenetrationFilter" step="0.001" placeholder="100.000">
                </div>
                <div class="filter-group">
                    <label for="minOrdersFilter">Min Orders</label>
                    <input type="number" id="minOrdersFilter" placeholder="0">
                </div>
                <div class="filter-group">
                    <label for="maxOrdersFilter">Max Orders</label>
                    <input type="number" id="maxOrdersFilter" placeholder="1000">
                </div>
                <div class="filter-group">
                    <label for="minPopulationFilter">Min Population</label>
                    <input type="number" id="minPopulationFilter" placeholder="0">
                </div>
                <div class="filter-group">
                    <label for="maxPopulationFilter">Max Population</label>
                    <input type="number" id="maxPopulationFilter" placeholder="100000">
                </div>
            </div>
            <div class="filter-group" style="margin-top: 15px;">
                <label>
                    <input type="checkbox" id="showCommercialFilter" style="margin-right: 8px;">
                    Show Commercial ZIP Codes (0 population)
                </label>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()">Clear All</button>
            </div>
        </div>

        <div class="data-table-container">
            <div class="table-header">
                <h3>Market Penetration Data</h3>
                <div class="table-info" id="tableInfo">Loading...</div>
            </div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="zipCode">ZIP Code</th>
                            <th class="sortable" data-sort="areaName">Area Name</th>
                            <th class="sortable" data-sort="population">Population</th>
                            <th class="sortable" data-sort="orderCount">Orders</th>
                            <th class="sortable" data-sort="netMV">Net MV ($)</th>
                            <th class="sortable" data-sort="marketPenetration">Market Penetration (%)</th>
                            <th class="sortable" data-sort="mvPerOrder">MV Per Order ($)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr><td colspan="7" class="loading">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let currentSort = { field: null, order: 'asc' };
        
        // Login System
        class LoginSystem {
            constructor() {
                this.loginOverlay = null;
                this.loginForm = null;
                this.loginFormContainer = null;
                this.passwordInput = null;
                this.loginError = null;
                this.loginBtn = null;
                this.loadingContainer = null;
                this.loadingMessage = null;
                
                this.loadingMessages = [
                    "Reading Joey's mind...",
                    "Making headaches for Jonathan...",
                    "Creating work for Stratos...",
                    "Seasoning the database...",
                    "Whisking up some tasks..."
                ];
                
                this.initializeLogin();
            }
            
            initializeLogin() {
                this.loginOverlay = document.getElementById('loginOverlay');
                this.loginForm = document.getElementById('loginForm');
                this.loginFormContainer = document.getElementById('loginFormContainer');
                this.passwordInput = document.getElementById('passwordInput');
                this.loginError = document.getElementById('loginError');
                this.loginBtn = document.getElementById('loginBtn');
                this.loadingContainer = document.getElementById('loadingContainer');
                this.loadingMessage = document.getElementById('loadingMessage');
                
                this.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
            }
            
            async handleLogin(e) {
                e.preventDefault();
                const enteredPassword = this.passwordInput.value;
                
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password: enteredPassword })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Store the session token
                        sessionStorage.setItem('authToken', result.token);
                        await this.startLoadingSequence();
                    } else {
                        this.showLoginError();
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    this.showLoginError();
                }
            }
            
            async startLoadingSequence() {
                this.loginForm.style.display = 'none';
                this.loadingContainer.style.display = 'block';
                this.loginFormContainer.classList.add('loading');
                
                for (let i = 0; i < this.loadingMessages.length; i++) {
                    await this.showLoadingMessage(this.loadingMessages[i], 1000);
                }
                
                sessionStorage.setItem('zipAnalyticsAuth', 'authenticated');
                await this.transitionToApp();
            }
            
            async showLoadingMessage(message, duration) {
                this.loadingMessage.textContent = message;
                this.loadingMessage.style.opacity = '1';
                await new Promise(resolve => setTimeout(resolve, duration));
                this.loadingMessage.style.opacity = '0';
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            async transitionToApp() {
                await new Promise(resolve => setTimeout(resolve, 300));
                this.loginOverlay.classList.add('fade-out');
                
                setTimeout(() => {
                    this.loginOverlay.style.display = 'none';
                    init(); // Initialize the main app
                }, 800);
            }
            
            checkAuth() {
                return sessionStorage.getItem('zipAnalyticsAuth') === 'authenticated';
            }
            
            hideLoginOverlay() {
                this.loginOverlay.style.display = 'none';
            }
            
            showLoginError() {
                this.loginError.style.display = 'block';
                this.passwordInput.value = '';
                this.passwordInput.focus();
                
                this.loginFormContainer.style.animation = 'shake 0.6s ease-in-out';
                
                setTimeout(() => {
                    this.loginError.style.display = 'none';
                    this.loginFormContainer.style.animation = '';
                }, 4000);
            }
        }
        
        // Initialize login system
        const loginSystem = new LoginSystem();

        // Initialize the application
        async function init() {
            try {
                await loadStats();
                await loadData();
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('dataTableBody').innerHTML = 
                    '<tr><td colspan="7" class="no-data">Error loading data</td></tr>';
            }
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (loginSystem.checkAuth()) {
                loginSystem.hideLoginOverlay();
                init();
            }
            
            // Sort handlers
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort(th.dataset.sort));
            });

            // Filter on enter key
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') applyFilters();
                });
            });
        });

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalZipCodes || 0}</div>
                        <div class="stat-label">Total ZIP Codes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalOrders || 0}</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${(stats.totalPopulation || 0).toLocaleString()}</div>
                        <div class="stat-label">Total Population</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.overallMarketPenetration || 'N/A'}%</div>
                        <div class="stat-label">Overall Penetration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.averageMarketPenetration || 'N/A'}%</div>
                        <div class="stat-label">Average Penetration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.maxMarketPenetration || 'N/A'}%</div>
                        <div class="stat-label">Max Penetration</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }


        // Load data with current filters
        async function loadData() {
            try {
                const queryParams = new URLSearchParams();
                
                // Get filter values
                const filters = {
                    zipCode: document.getElementById('zipCodeFilter').value,
                    areaName: document.getElementById('areaNameFilter').value,
                    minPenetration: document.getElementById('minPenetrationFilter').value,
                    maxPenetration: document.getElementById('maxPenetrationFilter').value,
                    minOrders: document.getElementById('minOrdersFilter').value,
                    maxOrders: document.getElementById('maxOrdersFilter').value,
                    minPopulation: document.getElementById('minPopulationFilter').value,
                    maxPopulation: document.getElementById('maxPopulationFilter').value
                };

                // Add non-empty filters to query params
                Object.entries(filters).forEach(([key, value]) => {
                    if (value) queryParams.append(key, value);
                });

                // Add commercial filter
                const showCommercial = document.getElementById('showCommercialFilter').checked;
                if (showCommercial) {
                    queryParams.append('hideCommercial', 'false');
                }

                // Add sorting
                if (currentSort.field) {
                    queryParams.append('sortBy', currentSort.field);
                    queryParams.append('sortOrder', currentSort.order);
                }

                const response = await fetch(`/api/data?${queryParams}`);
                const result = await response.json();
                
                currentData = result.data;
                updateTable(currentData);
                updateTableInfo(result.total);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dataTableBody').innerHTML = 
                    '<tr><td colspan="6" class="no-data">Error loading data</td></tr>';
            }
        }

        // Update table with data
        function updateTable(data) {
            const tbody = document.getElementById('dataTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No data found matching your filters</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(row => {
                const mvPerOrder = row.orderCount > 0 ? (row.netMV / row.orderCount) : 0;
                return `
                <tr>
                    <td>${row.zipCode}</td>
                    <td>${row.areaName || 'Unknown Area'}</td>
                    <td>${row.population ? row.population.toLocaleString() : 'N/A'}</td>
                    <td>${row.orderCount}</td>
                    <td>$${row.netMV.toFixed(2)}</td>
                    <td class="${getPenetrationClass(row.marketPenetration)}">
                        ${row.marketPenetration !== null ? row.marketPenetration.toFixed(6) + '%' : 'N/A'}
                    </td>
                    <td>$${mvPerOrder.toFixed(2)}</td>
                </tr>
                `;
            }).join('');
        }

        // Get CSS class for penetration value
        function getPenetrationClass(penetration) {
            if (penetration === null) return '';
            if (penetration >= 0.1) return 'penetration-high';
            if (penetration >= 0.01) return 'penetration-medium';
            return 'penetration-low';
        }

        // Update table info
        function updateTableInfo(total) {
            document.getElementById('tableInfo').textContent = `Showing ${total} records`;
        }

        // Apply filters
        function applyFilters() {
            loadData();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('zipCodeFilter').value = '';
            document.getElementById('areaNameFilter').value = '';
            document.getElementById('minPenetrationFilter').value = '';
            document.getElementById('maxPenetrationFilter').value = '';
            document.getElementById('minOrdersFilter').value = '';
            document.getElementById('maxOrdersFilter').value = '';
            document.getElementById('minPopulationFilter').value = '';
            document.getElementById('maxPopulationFilter').value = '';
            document.getElementById('showCommercialFilter').checked = false;
            currentSort = { field: null, order: 'asc' };
            updateSortHeaders();
            loadData();
        }

        // Handle column sorting
        function handleSort(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            updateSortHeaders();
            loadData();
        }

        // Update sort header styles
        function updateSortHeaders() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === currentSort.field) {
                    th.classList.add(currentSort.order === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });
        }

    </script>
</body>
</html>